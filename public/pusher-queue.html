<html>
<head>
	<title>Saviour Queue</title>
	<script src="http://js.pusher.com/2.0/pusher.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
</head>
<body>
	<div style="clear: both;">
		<div style="width: 50%; float: left;" id="savees">
		</div>
		<div style="width:50%; float: left;" id="saviours">
		</div>
	</div>
	<script>
	var SQueue = function(){
		var pusher = new Pusher('15d403a27437d1df3be4');
		var channel = pusher.subscribe('private-queue');
		var saviours = [];
		var savees = [];

		function connect(saviour, savee) {
			$.ajax({
				type: "POST",
				url: "/videoconference",
				data: {
					videoconference: {
						savee_id: savee.id,
						saviour_id: saviour.id
					}
				},
				success: function(data, status, jqXHR) {
					channel.trigger(saviour.id, 
						{
							session: data.token
						}
					);
					channel.trigger(savee.id, 
						{
							session: data.token
						}
					)
				},

				error: function(jqXHR, status, error) {
					// TODO: Some error handling here				
				}
			});
		}

		function tryToConnect() {
			if (saviours.length !== 0 && savees.length !== 0){
				connect(saviours.shift(), savees.shift());
				$("#saviours").children().first().remove();
				$("#savees").children().first().remove();
			}
		}

		channel.bind('client-add', function(data) {
			console.log('in add');
	  	if (data.type == 'savee') {
	  		savees.push(data.id);
	  		$("#savees").append("<div>"+data+"</div>");
	  	} else if (data.type == 'saviour') {
	  		saviours.push(data.id)
	  		$("#saviours").append("<div>"+data+"</div>");
	  	}
	  	tryToConnect();
	  });

		return {
			saviours : function() {
				return saviours;
			}(),

			savees : function() {
				return savees;
			}()
		}
	}

	var queue = new SQueue();
	</script>
</body>
</html>