<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

<% if @incidentReports.length <= 0 %>
<div class="container">
	There are no incidents to respond to !
</div>

<% else %>

	<div id="map-canvas" class="awesome-box" style="margin: 20px auto; width: 750px; height: 500px;"></div>
<% end %>

<script type="text/template" id="google-popup-template">
  [[= description ]]
</script>
<script>
_.templateSettings = {
    interpolate: /\[\[\=(.+?)\]\]/g,
    evaluate: /\[\[(.+?)\]\]/g
	};

<% if @incidentReports.length > 0 %>
	$(document).ready(function(){
	  function initialize() {   
	    var mapOptions = {
	      center: new google.maps.LatLng(<%= @incidentReports.first.latitude %>, <%= @incidentReports.first.longitude %>),
	      zoom: 12,
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	    };
	    var map = new google.maps.Map(document.getElementById("map-canvas"),
	        mapOptions);

	    var infowindow = new google.maps.InfoWindow();
	    var g_template = _.template($("#google-popup-template").html());
	    <% @incidentReports.each_with_index do |listing, index| %>
	      var marker = new google.maps.Marker({
	        position: new google.maps.LatLng(<%= listing.latitude%>,<%= listing.longitude %>),
	        icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=<%= index + 1%>|B9CCEB|000000',
	        map: map,
	      });

	      var content = g_template(<%= raw listing.to_json %>);

	      makeInfoWindowEvent(map, infowindow, content, marker, <%= listing.id %>);


	        
	    <% end %>
  }
  google.maps.event.addDomListener(window, 'load', initialize);

  function makeInfoWindowEvent(map, infowindow, contentString, marker, id) {
    google.maps.event.addListener(marker, 'click', function() {
      infowindow.setContent(contentString);
      infowindow.open(map, marker);
    });

    google.maps.event.addListener(marker, 'mouseover', function() {
      $('#'+id).css('background-color','#f9f9f9')
    });

    google.maps.event.addListener(marker, 'mouseout', function() {
      $('#'+id).css('background-color','#ffffff')
    });
  

  }

  });
<% end %>
</script>